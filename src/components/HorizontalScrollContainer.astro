---
interface Props {
  id: string;
}

const { id } = Astro.props;
---

<div class="hs-wrapper" id={id}>
  <div class="hs-container">
    <div class="hs-track">
      <slot />
    </div>
  </div>
</div>

<style is:global>
  .hs-wrapper {
    position: relative;
    width: 100%;
  }

  .hs-container {
    width: 100%;
    height: 100vh;
  }

  .hs-container.is-fixed {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 10;
  }

  .hs-container.at-end {
    position: absolute;
    bottom: 0;
    top: auto;
  }

  .hs-track {
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    height: 100%;
    width: max-content;
    will-change: transform;
    transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .hs-panel {
    flex: 0 0 100vw;
    width: 100vw;
    min-width: 100vw;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  @media (max-width: 900px) {
    .hs-wrapper {
      height: auto !important;
    }

    .hs-container {
      height: auto;
    }

    .hs-container.is-fixed,
    .hs-container.at-end {
      position: static;
    }

    .hs-track {
      flex-direction: column;
      width: 100%;
      transform: none !important;
      transition: none;
    }

    .hs-panel {
      flex: none;
      width: 100%;
      min-width: 100%;
      height: auto;
      min-height: auto;
    }
  }
</style>

<script>
  const MOBILE_BREAKPOINT = 900;

  function initHorizontalScroll() {
    const wrappers = document.querySelectorAll(".hs-wrapper");

    wrappers.forEach((wrapper) => {
      const container = wrapper.querySelector(".hs-container") as HTMLElement;
      const track = wrapper.querySelector(".hs-track") as HTMLElement;
      if (!container || !track) return;

      const panels = track.querySelectorAll(".hs-panel");
      const numPanels = panels.length;

      if (numPanels <= 1) return;

      const wrapperEl = wrapper as HTMLElement;
      let isEnabled = window.innerWidth > MOBILE_BREAKPOINT;

      const setupDesktop = () => {
        const totalHeight = numPanels * window.innerHeight;
        wrapperEl.style.height = `${totalHeight}px`;
      };

      const resetMobile = () => {
        wrapperEl.style.height = "auto";
        container.classList.remove("is-fixed", "at-end");
        track.style.transform = "none";
      };

      const handleScroll = () => {
        if (!isEnabled) return;

        const totalHeight = numPanels * window.innerHeight;
        const wrapperRect = wrapperEl.getBoundingClientRect();
        const wrapperTop = wrapperRect.top + window.scrollY;
        const scrollY = window.scrollY;
        const viewportHeight = window.innerHeight;
        const scrollableDistance = totalHeight - viewportHeight;

        const relativeScroll = scrollY - wrapperTop;

        if (relativeScroll < 0) {
          container.classList.remove("is-fixed", "at-end");
          track.style.transform = "translate3d(0, 0, 0)";
        } else if (relativeScroll >= scrollableDistance) {
          container.classList.remove("is-fixed");
          container.classList.add("at-end");
          const maxTranslate = (numPanels - 1) * window.innerWidth;
          track.style.transform = `translate3d(${-maxTranslate}px, 0, 0)`;
        } else {
          container.classList.add("is-fixed");
          container.classList.remove("at-end");
          const progress = relativeScroll / scrollableDistance;
          const maxTranslate = (numPanels - 1) * window.innerWidth;
          track.style.transform = `translate3d(${-progress * maxTranslate}px, 0, 0)`;
        }
      };

      const handleResize = () => {
        const wasEnabled = isEnabled;
        isEnabled = window.innerWidth > MOBILE_BREAKPOINT;

        if (isEnabled && !wasEnabled) {
          setupDesktop();
          handleScroll();
        } else if (!isEnabled && wasEnabled) {
          resetMobile();
        } else if (isEnabled) {
          setupDesktop();
          handleScroll();
        }
      };

      if (isEnabled) {
        setupDesktop();
      }

      window.addEventListener("scroll", handleScroll, { passive: true });
      window.addEventListener("resize", handleResize);
      handleScroll();
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initHorizontalScroll);
  } else {
    initHorizontalScroll();
  }
</script>
